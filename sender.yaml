esphome:
  name: lora_sender
  platform: ESP32
  board: esp32dev

  # 🔐 Register AES component on boot
  on_boot:
    priority: -100
    then:
      - lambda: |-
          auto aes = new esphome::hardware_aes::HardwareAESCBCComponent();
          aes->set_key_from_string(id(aes_key_str), 16);       // AES-128
          aes->set_hmac_key_from_string(id(hmac_key_str), 32); // HMAC-256
          App.register_component(aes);
          id(aes_component) = aes;

# 🧠 AES & HMAC Keys
globals:
  - id: aes_key_str
    type: std::string
    initial_value: "mysecretkey123"
  - id: hmac_key_str
    type: std::string
    initial_value: "anothersecretkey456"
  - id: aes_component
    type: esphome::hardware_aes::HardwareAESCBCComponent*
    restore_value: no
    initial_value: "nullptr"

external_components:
  - source:
      type: git
      url: https://github.com/cybermatte/esphome-hardware-aes-cbc
      ref: main
      path: esphome/components
    components: [hardware_aes]

logger:

# ✅ I²C for SHT40
i2c:
  sda: GPIO8
  scl: GPIO9
  scan: true

sensor:
  - platform: sht4x
    temperature:
      name: "SHT40 Temperature"
    humidity:
      name: "SHT40 Humidity"
    address: 0x44
    update_interval: 30s

# ✅ SPI for SX126x LoRa
spi:
  clk_pin: GPIO12
  mosi_pin: GPIO13
  miso_pin: GPIO14

sx126x:
  cs_pin: GPIO5
  reset_pin: GPIO6
  busy_pin: GPIO7

  frequency: 868MHz
  spreading_factor: 12
  bandwidth: 125kHz
  coding_rate: 4_5
  sync_word: 0x12

  transmit:
    id: lora_tx

# 📦 Custom Component to Encrypt and Send Payload
custom_component:
  - lambda: |-
      static uint8_t counter = 0;

      std::vector<uint8_t> payload = {
        0x01,  // Device ID
        counter++,
        (uint8_t)(id(temp_sht).state * 10),
        (uint8_t)(id(humidity_sht).state)
      };

      std::vector<uint8_t> encrypted;
      uint8_t iv[16];
      id(aes_component)->encrypt_cbc_with_hmac(payload, encrypted, iv);

      std::vector<uint8_t> packet(iv, iv + 16);
      packet.insert(packet.end(), encrypted.begin(), encrypted.end());

      id(lora).send_packet(packet);
      ESP_LOGI("sender", "Encrypted SHT40 sensor packet sent");
      return {};
    update_interval: 60s

